# üèóÔ∏è Stage 1: Build environment
FROM ubuntu:24.04
LABEL maintainer="Amar Akmal <amarakmal@mindmatics.my>"

# Install system dependencies required for build
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    wget \
    build-essential \
    curl \
    xvfb \
    nginx \
    tzdata \
    gettext-base \
    python3.12 \
    python3.12-venv \
    python3.12-dev && \
    curl -sS https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py && \
    python3.12 /tmp/get-pip.py --break-system-packages && \
    rm -f /tmp/get-pip.py && \
    apt-get clean && rm -rf /var/lib/apt/lists/*



# Install Python dependencies
RUN mkdir -p /var/www/be/
COPY requirements.txt /var/www/be/requirements.txt

# Set the working directory
WORKDIR /var/www/be

# Install Python dependencies
RUN pip install --break-system-packages --no-cache-dir -r requirements.txt

# Install Supervisor
RUN pip install --break-system-packages --no-cache-dir supervisor
RUN pip install --break-system-packages --no-cache-dir uwsgitop
RUN pip install --break-system-packages --no-cache-dir uwsgi
RUN pip install --break-system-packages --no-cache-dir pwdlib==0.3.0
RUN pip install --break-system-packages --no-cache-dir Flask-Cors==3.0.10
RUN pip install --break-system-packages --no-cache-dir "pwdlib[argon2]"

# Set up permissions and working directories
RUN mkdir -p /var/cache/fontconfig /var/www/temp /var/log/uwsgi && \
    chown -R www-data:www-data /var/cache/fontconfig /var/www/temp /var/log/uwsgi && \
    chmod 775 /var/cache/fontconfig /var/www/temp /var/log/uwsgi

# Expose ports
EXPOSE 80 443

# Default entrypoint
CMD ["bash"]



# 1.docker build --debug -f 1-Dockerfile-server-env -t fcs-be-env-server:v1 .
# 2. # docker tag   fcs-be-env-server:v1 192.168.5.130/iewes/fcs-be-env-server:v1

